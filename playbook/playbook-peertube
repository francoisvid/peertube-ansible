---
- name: deploiement peertube
  hosts: peertube
  tasks:

  - name: Add the user peertube
    user:
      name: peertube
      shell: /bin/bash
      password: peertube

  - name: installation des paquets necessaires
    package:
      name: "{{ paquets }}"
      state: latest
    vars:
      paquets:
      - ffmpeg 
      - openssl 
      - g++ 
      - make 
      - redis-server 
      - git
      - unzip

  - name: set permissions
    file:  
      path: /var/www/peertube
      state: directory
      owner: peertube
      group: peertube
      mode: 0755

  - name: set permissions
    file:  
      path: "/var/www/peertube/{{ item }}"
      state: directory
      owner: peertube
      group: peertube
      recurse: yes
      mode: 0755
    with_items:
      - config
      - storage
      - versions
  
  - name: download latest version of peertube
    unarchive:
      src: https://github.com/Chocobozzz/PeerTube/releases/download/v3.4.1/peertube-v3.4.1.zip
      dest: /var/www/peertube/
      owner: peertube
      group: peertube
      remote_src: yes    

  - name: set permissions
    file:
      path: /var/www/peertube/peertube-v3.4.1
      owner: peertube
      group: peertube
      recurse: yes
      mode: 0755

  - name: set permissions
    file:
      src: /var/www/peertube/peertube-v3.4.1
      dest: /var/www/peertube/peertube-latest
      owner: peertube
      group: peertube
      state: link

  - name: Copy peertube configuration file
    template:
      src: ../files/production.yaml
      dest: /var/www/peertube/config/production.yaml
      owner: peertube
      group: peertube
      mode: 0644

#- name: install npm 
#  npm:
#    path: /var/www/peertube/peertube-latest
    
     

  - name: Copy systemd unit file
    template:
      src: ../files/peertube.service
      dest: /etc/systemd/system/
      owner: root
      group: root
      mode: 0644  

  - name: enable and restart service
    service:
      name: peertube
      daemon_reload: yes
      enabled: yes
      state: restarted

  - name: wait for peertube to be started
    wait_for:
      port: 9000
      delay: 2
