---
- name: Deploiement de la bdd
  hosts: web1
  become: yes
  tasks:

  - name: installation des paquets necessaires
    apt:
      name: "{{ paquets }}"
      state: latest
    vars:
      paquets:
      - postgresql
      - python3-psycopg2

  - name: Demarrer le service
    service: "name={{ item }} state=started enabled=yes"
    with_items:
      - postgresql

  - name: gestion de la connexion peer
    template:
      src: ../files/pg_hba.conf
      dest: /etc/postgresql/14/main/pg_hba.conf
    notify: Redemarrer postgresql 

  - name: Création d'un utilisateur
    postgresql_user:
      state: present
      name: "{{ peertube_database_username }}"
      password: "{{ peertube_database_password }}"
      login_host: 127.0.0.1

  - name: Creation de la base de donnée
    postgresql_db:
      state: present
      name: "{{ peertube_database_name }}"
      login_host: 127.0.0.1
      owner: "{{ peertube_database_username }}"
   
  #  - name: "Grant db user access to app db"
  #   postgresql_privs:
  #     type: database
  #     database: "{{ peertube_database_name }}"
  #     roles: "GRANTS"
  #     grant_option: no
  #     privs: all
  #     login_host: 127.0.0.1
  #   login_password: "{{ db_password }}"
   

  # A VOIR POUR LES EXTENSIONS

  # - name: "Grant db user access to app db"
  #   postgresql_ext:

  # - name: configurer postgresql
  #   template:
  #     src: ../files/network_db
  #     dest: /etc/postgresql/14/main/conf.d
  #   notify: Redemarrer postgresql

  handlers:
  - name: Redemarrer postgresql
    service:
     name: postgresql
     state: restarted    
