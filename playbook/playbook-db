---

- hosts: postgresql
  tasks:

  - name: installation des paquets necessaires
    package:
      name: "{{ paquets }}"
      state: latest
    vars:
      paquets:
      - postgresql
      - python3-psycopg2

  - name: Demarrer le service
    service: "name={{ item }} state=started enabled=yes"
    with_items:
      - postgresql

#  - name: gestion de la connexion peer
#    template:
#      src: ../files/pg_hba.cfg
#      dest: /etc/postgresql/13/main/pg_hba.conf
#    notify: Redemarrer postgresql 
  
  
  


  - name: Creation de la base de donnée
    postgresql_db:
      owner: host
      login_user: "{{ db_user }}"
      login_password: "{{ db_password }}"
      name: "{{ db_name }}"
      login_unix_socket: /var/run/postgresql
    
  - name: Création d'un utilisateur
    postgresql_user:
      state: present
      name: "{{ db_user }}"
      password: "{{ db_password }}"
      login_unix_socket: /var/run/postgresql
   
  
  - name: "Grant db user access to app db"
    postgresql_privs:
      type: database
      database: "{{ db_name }}"
      roles: "{{ db_user }}"
      grant_option: no
      privs: all      


    
    

  - name: "Allow md5 connection for the db user"
    postgresql_pg_hba:
      dest: "~/data/pg_hba.conf"
      contype: host
      databases: all
      method: md5
      users: "{{ db_user }}"
      create: true
    notify: Redmarrer postgresql

  - name: configurer postgresql
    template:
      src: files/network_db
      dest: /etc/postgresql/13/main/conf.d
    notify: Redemarrer postgresql

  handlers:
    - name: Redemarrer postgresql
      service: name=postgresql state=restarted
