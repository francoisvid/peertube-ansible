---
- name: Deploiement de la bdd
  hosts: postgresql
  become: yes
  tasks:

  - name: installation des paquets necessaires
    package:
      name: "{{ paquets }}"
      state: latest
    vars:
      paquets:
      - postgresql
      - python3-psycopg2

  - name: Demarrer le service
    service: "name={{ item }} state=started enabled=yes"
    with_items:
      - postgresql

  - name: gestion de la connexion peer
    template:
      src: ../files/pg_hba.conf
      dest: /etc/postgresql/13/main/pg_hba.conf
    notify: Redemarrer postgresql 

  - name: Creation de la base de donnée
    postgresql_db:
      state: present
      name: "{{ db_name }}"
      login_host: 127.0.0.1
   

  - name: Création d'un utilisateur
    postgresql_user:
      state: present
      name: "{{ db_user }}"
      login_host: 127.0.0.1
   
  - name: "Grant db user access to app db"
    postgresql_privs:
      type: database
      database: "{{ db_name }}"
      roles: "{{ db_user }}"
      grant_option: no
      privs: all
      login_host: 127.0.0.1

  - name: configurer postgresql
    template:
      src: ../files/network_db
      dest: /etc/postgresql/13/main/conf.d
    notify: Redemarrer postgresql

  handlers:
  - name: Redemarrer postgresql
    service:
     name: postgresql
     state: restarted    
